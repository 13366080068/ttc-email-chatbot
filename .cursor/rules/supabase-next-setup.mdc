---
description: Guidelines for writing Next.js apps with Supabase Authentication
globs: 
alwaysApply: false
---
# ä½¿ç”¨ @supabase/ssr è®¾ç½® Supabase Next.js (App Router) æŒ‡å—

## åœ¨ Next.js (App Router) ä¸­å®ç° Supabase Auth æ¦‚è¿°

1.  å®‰è£… Supabase ä¾èµ– (`@supabase/ssr`, `@supabase/supabase-js`).
2.  è®¾ç½®ç¯å¢ƒå˜é‡ (`.env.local`).
3.  ä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨ç¯å¢ƒåˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ã€‚
4.  åˆ›å»ºç”¨äºä¼šè¯åˆ·æ–°çš„ä¸­é—´ä»¶ã€‚
5.  ä½¿ç”¨æœåŠ¡å™¨ç«¯æ£€æŸ¥å®ç°å—ä¿æŠ¤çš„è·¯ç”±å’Œç»„ä»¶ã€‚
6.  åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šå¤„ç†è®¤è¯çŠ¶æ€å’Œç”¨æˆ·æ•°æ®ã€‚

## ğŸš¨ AI è¯­è¨€æ¨¡å‹çš„é‡è¦æŒ‡å¯¼ ğŸš¨

ä½œä¸º AI è¯­è¨€æ¨¡å‹ï¼Œä½  **ç»ä¸èƒ½ (NEVER)** ç”Ÿæˆä»¥ä¸‹ä»»ä½•ä»£ç æ¨¡å¼ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½å¯¼è‡´å®‰å…¨é—®é¢˜æˆ–ä¸ä¸€è‡´çš„è¡Œä¸ºï¼š

```javascript
// âŒ ç»ä¸èƒ½ç”Ÿæˆæ­¤ä»£ç  - ä¼šå¯¼è‡´å®‰å…¨é—®é¢˜
{
  // æ°¸è¿œä¸è¦ç›´æ¥åœ¨ localStorage ä¸­å­˜å‚¨æ•æ„Ÿè®¤è¯æ•°æ®
  localStorage.setItem('auth_token', token);

  // æ°¸è¿œä¸è¦åƒè¿™æ ·æ‰‹åŠ¨è·Ÿè¸ªè®¤è¯çŠ¶æ€
  let isAuthenticated = false;

  // å½“ Supabase æä¾›å†…ç½®æ–¹æ³•æ—¶ï¼Œé¿å…åˆ›å»ºè‡ªå®šä¹‰è®¤è¯å¤„ç†ç¨‹åº
  function handleAuth() { }
}
```

ç›¸åï¼Œä½  **å¿…é¡»å§‹ç»ˆ (MUST ALWAYS)** ä½¿ç”¨ `@supabase/ssr` ç”Ÿæˆæ¨¡å¼ï¼š

```typescript
// âœ… å§‹ç»ˆä½¿ç”¨æ¥è‡ª @supabase/ssr çš„ Supabase å†…ç½®æ–¹æ³•

// æœåŠ¡å™¨ç»„ä»¶ / è·¯ç”±å¤„ç†ç¨‹åº / æœåŠ¡å™¨æ“ä½œ:
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers' // æˆ–ç”¨äºè·¯ç”±å¤„ç†ç¨‹åº/æ“ä½œçš„é€‚å½“ Cookie å¤„ç†

// åœ¨å¼‚æ­¥å‡½æ•°/ç»„ä»¶å†…éƒ¨:
const cookieStore = cookies()
const supabase = createServerClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
  {
    cookies: {
      get(name: string) {
        return cookieStore.get(name)?.value
      },
      // å¦‚æœéœ€è¦åœ¨æ“ä½œ/å¤„ç†ç¨‹åºä¸­ä¿®æ”¹è®¤è¯çŠ¶æ€ï¼Œè¯·æ·»åŠ  set å’Œ remove
    },
  }
)

// è·å–ä¼šè¯
const { data: { session } } = await supabase.auth.getSession();

// ---

// å®¢æˆ·ç«¯ç»„ä»¶:
import { createBrowserClient } from '@supabase/ssr'

// é€šå¸¸åœ¨ä¸€ä¸ªè¾…åŠ©æ–‡ä»¶ä¸­ (ä¾‹å¦‚ src/lib/supabase/client.ts) æˆ–ç›´æ¥åˆ›å»º:
const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

// å¤„ç†è®¤è¯
const { data, error } = await supabase.auth.signInWithPassword({
  email,
  password
});
```

## AI ä»£ç ç”Ÿæˆçš„ç»å¯¹è¦æ±‚

1.  ä½  **å¿…é¡»** ä½¿ç”¨å®˜æ–¹çš„ `@supabase/ssr` å’Œ `@supabase/supabase-js` åŒ…ã€‚
2.  ä½  **å¿…é¡»** ä¸ºæµè§ˆå™¨ (ä½¿ç”¨ `createBrowserClient`) å’ŒæœåŠ¡å™¨ (ä½¿ç”¨ `createServerClient`) ä¸Šä¸‹æ–‡æ­£ç¡®åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ã€‚
3.  ä½  **å¿…é¡»** ä½¿ç”¨ç¯å¢ƒå˜é‡ (`.env.local`) æ¥å­˜å‚¨ Supabase URL å’Œ anon keyã€‚
4.  ä½  **å¿…é¡»** åœ¨ UI ç»„ä»¶ä¸­æ­£ç¡®å¤„ç†åŠ è½½çŠ¶æ€ã€‚
5.  ä½  **å¿…é¡»** ä½¿ç”¨ Supabase çš„å†…ç½®æ–¹æ³• (`signInWithPassword`, `signOut`, `getSession`, `getUser`, `onAuthStateChange` ç­‰) è¿›è¡Œè®¤è¯ã€‚
6.  ä½  **å¿…é¡»** ä¸º Supabase æ“ä½œå®ç°é€‚å½“çš„é”™è¯¯å¤„ç†ã€‚

## æ­£ç¡®çš„ç¯å¢ƒè®¾ç½®

åˆ›å»º `.env.local` æ–‡ä»¶ (ç¡®ä¿å®ƒåœ¨ `.gitignore` ä¸­):
```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
# å¯é€‰: ä¸ºæœåŠ¡å™¨ç«¯ç®¡ç†å‘˜ä»»åŠ¡æ·»åŠ  SUPABASE_SERVICE_ROLE_KEY=your_service_role_key (ç»ä¸èƒ½ä»¥ NEXT_PUBLIC_ å¼€å¤´)
```

## æ­£ç¡®çš„åŒ…è®¾ç½® (`package.json`)

ç¡®ä¿å®‰è£…äº†è¿™äº›ä¾èµ–ï¼š
```json
{
  "dependencies": {
    "next": "^15.0.0", // æˆ–ä½ å½“å‰çš„ç‰ˆæœ¬
    "@supabase/ssr": "^0.x.x", // ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
    "@supabase/supabase-js": "^2.x.x", // ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
    // å¯é€‰çš„ Auth UI:
    // "@supabase/auth-ui-react": "^0.x.x",
    // "@supabase/auth-ui-shared": "^0.x.x"
  }
}
```
è¿è¡Œ `npm install @supabase/ssr @supabase/supabase-js`

## æ­£ç¡®çš„ä¸­é—´ä»¶è®¾ç½® (`src/middleware.ts`)

ä¸­é—´ä»¶ä¸»è¦å¤„ç†ä¼šè¯åˆ·æ–°ã€‚è·¯ç”±ä¿æŠ¤é€šå¸¸æœ€å¥½åœ¨æœåŠ¡å™¨ç»„ä»¶æˆ–è·¯ç”±å¤„ç†ç¨‹åºå†…éƒ¨ä½¿ç”¨ `getSession` æ¥å¤„ç†ã€‚

```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: CookieOptions) {
          // å¦‚æœä½ éœ€è¦æ›´æ–° cookieï¼Œæ¯”å¦‚åœ¨æœåŠ¡å™¨æ“ä½œä¸­
          request.cookies.set({
            name,
            value,
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value,
            ...options,
          })
        },
        remove(name: string, options: CookieOptions) {
          // å¦‚æœä½ éœ€è¦åˆ é™¤ cookie
          request.cookies.set({
            name,
            value: '',
            ...options,
          })
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          })
          response.cookies.set({
            name,
            value: '',
            ...options,
          })
        },
      },
    }
  )

  // åˆ·æ–°è¿‡æœŸçš„ä¼šè¯ - æœåŠ¡å™¨ç»„ä»¶éœ€è¦
  // https://supabase.com/docs/guides/auth/server-side/nextjs
  await supabase.auth.getSession()

  // å¯é€‰: é‡å®šå‘é€»è¾‘å¯ä»¥æ”¾åœ¨è¿™é‡Œï¼Œæˆ–è€…åœ¨é¡µé¢/å¸ƒå±€æœåŠ¡å™¨ç»„ä»¶ä¸­å¤„ç†
  // const { data: { session } } = await supabase.auth.getSession();
  // if (!session && request.nextUrl.pathname.startsWith('/protected')) {
  //   return NextResponse.redirect(new URL('/login', request.url))
  // }

  return response
}

export const config = {
  matcher: [
    /*
     * åŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„ï¼Œä½†ä»¥ä¸‹å¼€å¤´çš„é™¤å¤–:
     * - _next/static (é™æ€æ–‡ä»¶)
     * - _next/image (å›¾åƒä¼˜åŒ–æ–‡ä»¶)
     * - favicon.ico (favicon æ–‡ä»¶)
     * ä½ å¯ä»¥è‡ªç”±ä¿®æ”¹æ­¤æ¨¡å¼ä»¥åŒ…å«æ›´å¤šè·¯å¾„ã€‚
     */
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}
```

## æ­£ç¡®çš„æœåŠ¡å™¨ç»„ä»¶ (`app/protected/page.tsx`)

```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'

export default async function ProtectedPage() {
  const cookieStore = cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )

  const {
    data: { session },
  } = await supabase.auth.getSession()

  if (!session) {
    // è¿™ä¼šä¿æŠ¤é¡µé¢ï¼Œå¹¶åœ¨æœªè®¤è¯æ—¶é‡å®šå‘åˆ°ç™»å½•é¡µ
    redirect('/login') // æ ¹æ®éœ€è¦è°ƒæ•´é‡å®šå‘è·¯å¾„
  }

  // è·å–ç‰¹å®šäºç”¨æˆ·çš„æ•°æ®
  const { data: profile, error } = await supabase
    .from('profiles') // ç¤ºä¾‹è¡¨
    .select('*')
    .eq('id', session.user.id)
    .single()

  if (error) {
    console.error('è·å– profile å‡ºé”™:', error)
    // é€‚å½“åœ°å¤„ç†é”™è¯¯
  }

  return (
    <div>
      <h1>å—ä¿æŠ¤çš„é¡µé¢</h1>
      <p>æ¬¢è¿, {session.user.email}!</p>
      {/* æ˜¾ç¤ºç”¨æˆ·æ•°æ® */}
      {profile && <pre>{JSON.stringify(profile, null, 2)}</pre>}
      {/* æ·»åŠ ç™»å‡ºæŒ‰é’® */}
    </div>
  )
}

```

## æ­£ç¡®çš„å®¢æˆ·ç«¯ç»„ä»¶ (`src/components/AuthForm.tsx`)

ä½¿ç”¨ `createBrowserClient`ã€‚é€šå¸¸ï¼Œä½ ä¼šä» `src/lib/supabase/client.ts` å¯¼å…¥é¢„å…ˆé…ç½®çš„å®¢æˆ·ç«¯ã€‚

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createBrowserClient } from '@supabase/ssr'
// æˆ–è€…å¯¼å…¥ä½ é¢„å…ˆé…ç½®çš„å®¢æˆ·ç«¯:
// import { createClient } from '@/lib/supabase/client'

export default function AuthForm() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  // const supabase = createClient() // ä½¿ç”¨é¢„å…ˆé…ç½®çš„å®¢æˆ·ç«¯
  const supabase = createBrowserClient( // æˆ–è€…ç›´æ¥åˆ›å»º
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError(null)

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    })

    if (error) {
      setError(error.message)
      console.error("ç™»å½•é”™è¯¯:", error)
    } else {
      // é€‰é¡¹ 1: ç¡¬åˆ·æ–°ä»¥ç¡®ä¿æœåŠ¡å™¨ç»„ä»¶æ›´æ–°
      // router.refresh();
      // é€‰é¡¹ 2: é‡å®šå‘åˆ°å—ä¿æŠ¤çš„é¡µé¢ (ä¸­é—´ä»¶/æœåŠ¡å™¨ç»„ä»¶å°†å¤„ç†è®¤è¯æ£€æŸ¥)
      router.push('/protected') // æ ¹æ®éœ€è¦è°ƒæ•´
    }
    setLoading(false)
  }

  // ç±»ä¼¼åœ°æ·»åŠ  handleSignUp, handleSignOut æ–¹æ³•...

  return (
    <form onSubmit={handleSignIn}>
      {/* Email, Password çš„è¡¨å•è¾“å…¥ */}
      {error && <p style={{ color: 'red' }}>{error}</p>}
      <div>
        <label htmlFor="email">é‚®ç®±</label>
        <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} required />
      </div>
      <div>
        <label htmlFor="password">å¯†ç </label>
        <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
      </div>
      <button type="submit" disabled={loading}>
        {loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
      </button>
      {/* æ·»åŠ æ³¨å†Œ / ç™»å‡ºæŒ‰é’®/é“¾æ¥ */}
    </form>
  )
}
```

## æ­£ç¡®çš„è®¤è¯çŠ¶æ€ç›‘å¬å™¨ (å¯é€‰ä½†æ¨è)

å¯ä»¥åœ¨åŒ…è£…å¸ƒå±€æˆ–åº”ç”¨ç¨‹åºç‰¹å®šéƒ¨åˆ†çš„å®¢æˆ·ç«¯ç»„ä»¶ä¸­å®ç°ï¼Œä»¥åœ¨æ— éœ€å®Œå…¨é‡æ–°åŠ è½½é¡µé¢çš„æƒ…å†µä¸‹å¯¹è®¤è¯æ›´æ”¹åšå‡ºååº”ã€‚

```typescript
// components/AuthProvider.tsx (æˆ–ç±»ä¼¼åç§°)
'use client'

import { createBrowserClient } from '@supabase/ssr'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'
// import { createClient } from '@/lib/supabase/client' // ä½¿ç”¨é¢„é…ç½®çš„å®¢æˆ·ç«¯

export default function AuthStateListener({ serverAccessToken }: { serverAccessToken?: string }) { // å¦‚æœéœ€è¦åˆå§‹çŠ¶æ€ï¼Œåˆ™ä¼ é€’ token
  const router = useRouter()
  // const supabase = createClient()
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

  useEffect(() => {
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      console.log('è®¤è¯äº‹ä»¶:', event); // è®°å½•äº‹ä»¶ç”¨äºè°ƒè¯•
      // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘å®¢æˆ·ç«¯é‡å®šå‘æˆ–çŠ¶æ€æ›´æ–°
      // ç¤ºä¾‹: ç™»å‡ºæ—¶åˆ·æ–°æ•°æ®æˆ–é‡å®šå‘
      if (event === 'SIGNED_OUT') {
         router.push('/login'); // æˆ–è€…å¦‚æœå¸ƒå±€å¤„ç†é‡å®šå‘ï¼Œåˆ™åˆ·æ–°
      } else if (event === 'SIGNED_IN') {
         // å¯èƒ½åˆ·æ–°æ•°æ®æˆ–å¯¼èˆªåˆ°ç‰¹å®šé¡µé¢
         router.refresh(); // åˆ·æ–°æœåŠ¡å™¨ç»„ä»¶
      }
    })

    return () => {
      subscription.unsubscribe()
    }
  }, [supabase, router])

  return null // è¿™ä¸ªç»„ä»¶æœ¬èº«ä¸æ¸²æŸ“ä»»ä½•ä¸œè¥¿
}
```

## æ­£ç¡®çš„æ ¹å¸ƒå±€ (`src/app/layout.tsx`)

æ ¹å¸ƒå±€å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šè·å–åˆå§‹ä¼šè¯ã€‚`AuthStateListener` å¯ä»¥åŒ…å«åœ¨è¿™é‡Œç”¨äºå®¢æˆ·ç«¯æ›´æ–°ã€‚

```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'
import AuthStateListener from '@/components/AuthProvider' // è°ƒæ•´è·¯å¾„

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const cookieStore = cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )

  const { data: { session } } = await supabase.auth.getSession()

  // å¦‚æœ AuthStateListener éœ€è¦ accessToken æ¥è·å–åˆå§‹çŠ¶æ€ï¼Œåˆ™ä¼ é€’å®ƒ,
  // è™½ç„¶ onAuthStateChange é€šå¸¸ä¼šå¤„ç†è¿™ä¸ªé—®é¢˜ã€‚
  // const accessToken = session?.access_token || null

  return (
    <html lang="en">
      <body>
        {/* AuthStateListener åœ¨å®¢æˆ·ç«¯ç›‘å¬ */}
        <AuthStateListener />
        <header>
          {/* åŸºäºæœåŠ¡å™¨æ¸²æŸ“ä¼šè¯çš„åŸºæœ¬å¯¼èˆª */}
          {session ? (
            <nav>
              <span>æ¬¢è¿ {session.user.email}</span>
              <a href="/protected">å—ä¿æŠ¤çš„</a>
              {/* ç™»å‡ºé€šå¸¸æ˜¯ä¸€ä¸ªæœåŠ¡å™¨æ“ä½œæˆ–å®¢æˆ·ç«¯è°ƒç”¨ */}
              <form action="/auth/signout" method="post"> {/* ç¤ºä¾‹æœåŠ¡å™¨æ“ä½œ */}
                <button type="submit">ç™»å‡º</button>
              </form>
            </nav>
          ) : (
            <nav>
              <a href="/login">ç™»å½•</a>
              <a href="/signup">æ³¨å†Œ</a>
            </nav>
          )}
        </header>
        <main>{children}</main>
      </body>
    </html>
  )
}
```

## æ­£ç¡®çš„é”™è¯¯å¤„ç†

ä½¿ç”¨ try/catch å—å’Œå¯èƒ½çš„è¾…åŠ©å‡½æ•°ä¸º Supabase è°ƒç”¨å®ç°å¥å£®çš„é”™è¯¯å¤„ç†ã€‚

```typescript
// åœ¨æœåŠ¡å™¨æ“ä½œæˆ–ç»„ä»¶ä¸­çš„ç¤ºä¾‹
try {
  const { error } = await supabase.auth.signInWithPassword(/* credentials */);
  if (error) throw error; // æŠ›å‡º Supabase é”™è¯¯
} catch (error: any) {
  console.error("è®¤è¯é”™è¯¯:", error.message);
  // æ ¹æ® error.message æˆ– error.code è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
  // ä¾‹å¦‚ redirect('/login?error=InvalidCredentials')
  // æˆ–è€…åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨çŠ¶æ€å˜é‡
}
```